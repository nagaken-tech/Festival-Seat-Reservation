# Festival-Seat-Reservation
中夜祭予約システム


1.はじめに・制作の経緯
今まで行われていたMusic concert(Mコン)の聖学院側の座席指定は、お客さんが指定のgoogleフォームに入力することで座席の予約をしていた。
その際、もちろん好きな座席の指定などできるわけもなかった。
一方でどのように座席を割り振ったかというと、記念祭生徒運営本部が予約代表者氏名と人数を確認してチケット用紙に手書きで座席を割り振っていた。そのためヒューマンエラーによるダブルブッキングが起こってトラブルになるケースもあった。
これらの問題点を解決するため、
・映画館や新幹線の座席予約サイトのような形でお客さんが自由に座席を選択できる形に
・同時に半自動券面作成・発券システムを作成
することで運営の業務軽減を図ることを目的に制作をした。

2.操作方法・仕様
1.座席選択画面について

基本的に触ってみるとわかるが、上のところで入力した人数分の席数のみ座席の選択が可能になっている。
⭐️学籍番号について
学籍番号から以下のことを判別・利用するシステムにしている
・入学年度＝学年
→いたずら防止のため入力された学籍番号と学年が一致しない場合に予約拒否をする
・同一学籍番号による二重申込防止
・特定の生徒の座席位置の制限
→※対象者はコード画面からIndex.htmlの中にその人の学籍番号が書いてある。
・入力された学籍番号＋@seig-boys.jpで生徒のメールアドレスに予約情報を送信
・チケット発券時に学生証にあるバーコードを利用するため
（学生証にあるバーコードの中身は学籍番号になっている）

一通り入力し、予約するを押すと予約処理が開始される。
予約処理の実行中には、
他に同じ席を選択して予約処理をしている人がいないかなどがチェックされる
＝ダブルブッキング防止
成功すれば成功の表示→メールが自動送信され、予約確定
失敗→エラーメッセージが表示され、再入力。
予約が確定されると、管理用画面の Reservations  に記録される。

2.管理者用発券サイトについて

このようなUIとなっている。
URLの末尾に「?page=printer」をつけるとアクセスできる。
聖学院では当日は広報部よりバーコードリーダーを（借りられたら）借り、
学生証のバーコードをスキャンすると学籍番号の欄に入力される。なお、仕様として大文字小文字の区別はされないようになっている(バージョン27(V1-α2)以降)。手打ちでの入力も可能。
入力後、検索を押すとシステムが予約情報の照会を開始し、予約が確認できるとこのような画面になる。



ここで印刷・発券を押すとブラウザの印刷ダイアログが立ち上がり、直接印刷ができる。
また、このボタンを押した時点で発券情報がTUREになり、二重発券ができなくなる。
仕様上印刷ダイアログが立ち上がったあとに動作をキャンセルしても発券情報はTUREのままなので注意が必要。直したい場合は Reservations  を手書きで修正する。
また、そのタイミングでチケットの再発行用バックアップをとるために、 チケットPDF に印刷用チケットデータが出力される。

このチケットのテンプレートは FunFestival Ticket Template を元に生成される。
デザインは正規のものと区別がつくように変えているので、ここのドキュメントを変更すれば生成されるPDFのデザインも変更可能。



3.制作ツール・仕組み
主な使用ツールはGoogle Apps Script(以下GASと略す)というGoogleが提供しているJava Script(以下JSと略す)ベースのプログラミング言語を使用した。
主にGoogle関連のサービスを自動化するときに使う。Googleのサーバー上で稼働するため、誰かのPCを犠牲にすることなく使用ができる。ただし、高負荷なものはエラーを起こしやすくなるので注意。
正直私はJSについてほとんど触ったことがなく、素人状態だったので7割8割ChatGPTとGeminiに頼った。最近の生成AIはエラーの少ないコードを作ってくれるので本当に簡単に作成できた。
先にスプレッドシートResavationを作成してから、そこから拡張機能でGASファイルを作成し、制作した。
このシステムは、予約システムのフロントエンドはIndex.html、発券システムのフロントエンドはTicketPrinter.htmlとなっている。バックエンドはCode.gsで両方とも同じファイルで制御している。
予備チケットの発行にはgoogle driveとgoogle docsのサービスを利用している。

1. 座席予約システム
ユーザーインターフェース: Index.html が予約フォームのフロントエンドとして機能します。ユーザーは映画館や新幹線の予約サイトのように、視覚的に座席を選び予約できます。
座席の選択と重複防止: 人数分の座席のみ選択可能で、既に予約された座席は選択できないようになっています。これにより、ヒューマンエラーによるダブルブッキングをシステムが自動的にチェックし、防止します。
学籍番号による認証と制御: 学籍番号を利用して以下の機能を提供します。
学年判別: 入力された学籍番号と選択された学年が一致しない場合、予約を拒否し、いたずらを防止します。
二重申込防止: 同一学籍番号による複数回の予約申込を防止します。
特定の生徒の座席制限: 特定の生徒（学籍番号が Index.html 内に記載されている対象者）に対して、座席の位置に関する制限を設定できます。
予約情報の自動送信: 入力された学籍番号に @seig-boys.jp を付加し、生徒のメールアドレス宛に予約内容の確認メールを自動で送信します。
予約処理: ユーザーが「予約する」ボタンを押すと予約処理が開始されます。この際、他者との同時予約によるダブルブッキングを防ぐための最終チェックが行われます。
予約結果の通知: 予約処理が成功した場合、成功メッセージが表示され、予約情報が確定するとともに自動でメールが送信されます。失敗した場合は、エラーメッセージが表示され、再入力を促します。
データ記録: 予約が確定されると、予約情報が管理用の Google スプレッドシート Reservations に自動的に記録されます。

これ以外は特筆すべき事項はありませんが、バックエンドにてロックサービスによる排他制御を行っています。複数のユーザーが同時に予約を実行した場合でも、データの整合性を保つために Google Apps Script のスクリプトロックサービスを活用し、データ競合(ダブルブッキング)を防いでいます。
また、ユーザー操作やシステム処理中に発生しうる様々なエラー（例：座席の重複、予約情報の不一致、予約未検出など）を検知し、適切なエラーメッセージをフロントエンドに返してユーザーに通知するシステムを構築しています。




## ライセンス / License
このプログラムの著作権は作成者に帰属します。
コンテスト応募およびポートフォリオとしての公開であり、第三者による無断での利用・複製・改変・再配布を禁じます。

This software is released for portfolio purposes only.
Unauthorized copying, modification, or distribution of this software is strictly prohibited.
All Rights Reserved.
